<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê´‘ìš´ëŒ€ ìº í¼ìŠ¤ ê¸¸ì°¾ê¸°</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Noto Sans KR', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        h3 {
            margin: 0 0 10px 0;
            color: #800020;
            /* ê´‘ìš´ëŒ€ ìƒì§•ìƒ‰ ë¹„ìŠ·í•˜ê²Œ */
        }

        select,
        button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background-color: #800020;
            color: white;
            border: none;
            font-weight: bold;
        }

        button:hover {
            background-color: #600018;
        }

        button#btn-gps {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
        }

        .options {
            display: flex;
            gap: 15px;
            font-size: 14px;
            align-items: center;
        }

        .result-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
            color: #333;
            min-height: 20px;
        }

        /* ë””ë²„ê·¸ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .debug-box {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            font-size: 13px;
        }

        .debug-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 5px;
            display: block;
        }
    </style>
</head>

<body>

    <div class="control-panel">
        <h3>ğŸš€ ê´‘ìš´ëŒ€ ë„¤ë¹„ê²Œì´ì…˜</h3>

        <button id="btn-gps">ğŸ“ ë‚´ ìœ„ì¹˜ ì°¾ê¸°</button>
        <div id="gps-status" style="font-size: 12px; color: gray;">ìœ„ì¹˜ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.</div>

        <hr style="width: 100%; border: 0.5px solid #eee;">

        <label>ëª©ì ì§€ ì„ íƒ:</label>
        <select id="destination-select">
            <option value="">ë¹Œë”©ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>

        <div class="options">
            <label><input type="checkbox" id="avoidStair"> ê³„ë‹¨ íšŒí”¼ ğŸªœ</label>
            <label><input type="checkbox" id="avoidCrub"> í„± íšŒí”¼ ğŸ¦½</label>
        </div>

        <button id="btn-find">ê¸¸ì°¾ê¸° ì‹œì‘</button>

        <div id="result-msg" class="result-box">ê²½ë¡œ ëŒ€ê¸° ì¤‘...</div>

        <div class="debug-box">
            <span class="debug-title">ğŸ› ï¸ ë°ì´í„° ê²€ì¦ (Dev Mode)</span>
            <label><input type="checkbox" id="chk-show-nodes"> ëª¨ë“  ë…¸ë“œ ë³´ê¸° (ğŸ”µ)</label><br>
            <label><input type="checkbox" id="chk-show-edges"> ëª¨ë“  ì—£ì§€ ë³´ê¸° (â–)</label>
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=311249e270cbeaab55beccff189121ab"></script>

    <script>
        // --- 1. ì§€ë„ ì´ˆê¸°í™” ---
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.619501, 127.059594), // ê´‘ìš´ëŒ€ ì¤‘ì‹¬
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // ì „ì—­ ë³€ìˆ˜ë“¤
        var userLat = null;
        var userLng = null;
        var userMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        var currentPolyline = null; // ê·¸ë ¤ì§„ ê²½ë¡œ ì„ 
        var nodeDataMap = {}; // ë…¸ë“œ ID -> ì¢Œí‘œ ì •ë³´ ë§¤í•‘ìš©

        // ë””ë²„ê¹…ìš© ê°ì²´ë“¤ì„ ë‹´ì„ ë°°ì—´
        var debugNodeMarkers = [];
        var debugEdgePolylines = [];

        // --- 2. ë°ì´í„° ë¡œë”© (ë¹Œë”© ëª©ë¡ & ë…¸ë“œ ì¢Œí‘œ) ---
        window.onload = function () {
            // (1) ë¹Œë”© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (/api/buildings)
            fetch('/api/buildings')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('destination-select');
                    data.forEach(b => {
                        const option = document.createElement('option');
                        option.value = b.id; // ì˜ˆ: "BimaHall"
                        option.text = b.name; // ì˜ˆ: "ë¹„ë§ˆê´€"
                        select.appendChild(option);
                    });
                })
                .catch(err => console.error("ë¹Œë”© ë¡œë“œ ì‹¤íŒ¨:", err));

            // (2) ì „ì²´ ë…¸ë“œ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸° (/api/nodes) - ê²½ë¡œ ê·¸ë¦¬ê¸°ìš©
            fetch('/api/nodes')
                .then(res => res.json())
                .then(data => {
                    data.forEach(node => {
                        nodeDataMap[node.id] = node.location; // IDë¡œ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ìˆê²Œ ì €ì¥
                    });
                    console.log("ë…¸ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", Object.keys(nodeDataMap).length + "ê°œ");
                });
        };

        // --- ë””ë²„ê·¸ ê¸°ëŠ¥: ë…¸ë“œ ë³´ê¸° ---
        document.getElementById('chk-show-nodes').addEventListener('change', function (e) {
            if (e.target.checked) {
                // ë…¸ë“œ ê·¸ë¦¬ê¸°
                for (const [id, loc] of Object.entries(nodeDataMap)) {
                    var marker = new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(loc.lat, loc.lng),
                        title: id,
                        image: new kakao.maps.MarkerImage(
                            'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', // ì¹´ì¹´ì˜¤ ê³µì‹ ë³„ ì´ë¯¸ì§€
                            new kakao.maps.Size(24, 35) // ì´ë¯¸ì§€ í¬ê¸°
                        )
                    });
                    marker.setMap(map);

                    // í´ë¦­ì‹œ ID ì•Œë ¤ì£¼ëŠ” ì¸í¬ìœˆë„ìš° ì¶”ê°€ (ì¢Œí‘œ í™•ì¸ìš©)
                    kakao.maps.event.addListener(marker, 'click', function () {
                        alert(`Node ID: ${id}\nLat: ${loc.lat}\nLng: ${loc.lng}`);
                    });

                    debugNodeMarkers.push(marker);
                }
            } else {
                // ì§€ìš°ê¸°
                debugNodeMarkers.forEach(m => m.setMap(null));
                debugNodeMarkers = [];
            }
        });

        // --- ë””ë²„ê·¸ ê¸°ëŠ¥: ì—£ì§€ ë³´ê¸° ---
        document.getElementById('chk-show-edges').addEventListener('change', function (e) {
            if (e.target.checked) {
                fetch('/api/edges')
                    .then(res => res.json())
                    .then(edges => {
                        edges.forEach(edge => {
                            const fromLoc = nodeDataMap[edge.from];
                            const toLoc = nodeDataMap[edge.to];
                            if (fromLoc && toLoc) {
                                var line = new kakao.maps.Polyline({
                                    path: [
                                        new kakao.maps.LatLng(fromLoc.lat, fromLoc.lng),
                                        new kakao.maps.LatLng(toLoc.lat, toLoc.lng)
                                    ],
                                    strokeWeight: 3,
                                    strokeColor: '#A0A0A0', // íšŒìƒ‰
                                    strokeOpacity: 0.6,
                                    strokeStyle: 'solid'
                                });
                                line.setMap(map);
                                debugEdgePolylines.push(line);
                            }
                        });
                        alert(`ì´ ${edges.length}ê°œì˜ ì—£ì§€ë¥¼ ê·¸ë ¸ìŠµë‹ˆë‹¤.`);
                    });
            } else {
                debugEdgePolylines.forEach(line => line.setMap(null));
                debugEdgePolylines = [];
            }
        });

        // --- 3. GPS ë‚´ ìœ„ì¹˜ ì°¾ê¸° ---
        document.getElementById('btn-gps').addEventListener('click', function () {
            if (navigator.geolocation) {
                document.getElementById('gps-status').innerText = "ìœ„ì¹˜ í™•ì¸ ì¤‘...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;

                        var locPosition = new kakao.maps.LatLng(userLat, userLng);
                        document.getElementById('gps-status').innerText = "ë‚´ ìœ„ì¹˜: í™•ì¸ë¨ âœ…";

                        // ë§ˆì»¤ í‘œì‹œ ë° ì§€ë„ ì´ë™
                        if (userMarker) userMarker.setMap(null);
                        userMarker = new kakao.maps.Marker({ map: map, position: locPosition });
                        map.setCenter(locPosition);
                    },
                    (err) => {
                        alert("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ ì¼œì£¼ì„¸ìš”.");
                        document.getElementById('gps-status').innerText = "ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨";
                    }
                );
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });

        // --- 3-1. [ì¶”ê°€ë¨] ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ---
        kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
            // í´ë¦­í•œ ìœ„ë„, ê²½ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ 
            var latlng = mouseEvent.latLng;

            // ë§ˆì»¤ ìœ„ì¹˜ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ë¡œ ì˜®ê¹ë‹ˆë‹¤
            updateUserLocation(latlng.getLat(), latlng.getLng(), "ë‚´ ìœ„ì¹˜: ì§€ë„ì—ì„œ ì„ íƒë¨ ğŸ‘†");
        });

        // [ê³µí†µ í•¨ìˆ˜] ì‚¬ìš©ì ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ë° ë§ˆì»¤ í‘œì‹œ
        function updateUserLocation(lat, lng, msg) {
            userLat = lat;
            userLng = lng;

            var locPosition = new kakao.maps.LatLng(lat, lng);
            document.getElementById('gps-status').innerText = msg;
            document.getElementById('gps-status').style.color = "#006400"; // ì§„í•œ ë…¹ìƒ‰

            // ê¸°ì¡´ ë§ˆì»¤ ìˆìœ¼ë©´ ì œê±° í›„ ìƒˆë¡œ ìƒì„± (í˜¹ì€ ì´ë™)
            if (userMarker) {
                userMarker.setMap(null);
            }

            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± (ì´ë¯¸ì§€ ë“±ì„ ë‹¤ë¥´ê²Œ í•  ìˆ˜ë„ ìˆìŒ)
            userMarker = new kakao.maps.Marker({
                map: map,
                position: locPosition
            });

            // ì§€ë„ ì¤‘ì‹¬ì„ ë‚´ ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™í•˜ì§€ ì•ŠìŒ (í´ë¦­ ì‹œ ë¶ˆí¸í•  ìˆ˜ ìˆì–´ì„œ)
            // GPS ë²„íŠ¼ ëˆŒë €ì„ ë•Œë§Œ ì´ë™í•˜ê³  ì‹¶ìœ¼ë©´ ë¡œì§ ë¶„ë¦¬ ê°€ëŠ¥. ì—¬ê¸°ì„œëŠ” í´ë¦­ í¸ì˜ì„±ì„ ìœ„í•´ ì¤‘ì‹¬ ì´ë™ì€ ëºŒ.
        }

        // --- 4. ê¸¸ì°¾ê¸° ìš”ì²­ ë° ê·¸ë¦¬ê¸° ---
        document.getElementById('btn-find').addEventListener('click', function () {
            // ì…ë ¥ê°’ ê²€ì¦
            if (!userLat || !userLng) {
                alert("ë¨¼ì € 'ë‚´ ìœ„ì¹˜ ì°¾ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
                return;
            }
            const buildingId = document.getElementById('destination-select').value;
            if (!buildingId) {
                alert("ëª©ì ì§€ ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const avoidStair = document.getElementById('avoidStair').checked;
            const avoidCrub = document.getElementById('avoidCrub').checked;

            // API í˜¸ì¶œ (/api/find)
            const url = `/api/find?lat=${userLat}&lng=${userLng}&building=${buildingId}&avoidStair=${avoidStair}&avoidCrub=${avoidCrub}`;

            document.getElementById('result-msg').innerText = "ê²½ë¡œ íƒìƒ‰ ì¤‘...";

            fetch(url)
                .then(res => {
                    if (!res.ok) throw new Error("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return res.json();
                })
                .then(result => {
                    // ê²°ê³¼ ì²˜ë¦¬
                    document.getElementById('result-msg').innerText =
                        `ê±°ë¦¬: ${result.cost}m (ê²½ë¡œ ë…¸ë“œ ${result.path.length}ê°œ)`;

                    drawPath(result.path); // ê²½ë¡œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                })
                .catch(err => {
                    alert("ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì˜µì…˜ì„ ë³€ê²½í•´ë³´ì„¸ìš”)");
                    document.getElementById('result-msg').innerText = "ê²½ë¡œ ì—†ìŒ âŒ";
                    if (currentPolyline) currentPolyline.setMap(null);
                });
        });

        // --- 5. ì§€ë„ì— ì„  ê·¸ë¦¬ê¸° (Polyline) ---
        function drawPath(pathNodeIds) {
            // ê¸°ì¡´ ì„  ì§€ìš°ê¸°
            if (currentPolyline) currentPolyline.setMap(null);

            // ë…¸ë“œ ID ë¦¬ìŠ¤íŠ¸ -> ì¹´ì¹´ì˜¤ ì¢Œí‘œ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
            var linePath = [];
            pathNodeIds.forEach(id => {
                const loc = nodeDataMap[id]; // ì•„ê¹Œ ì €ì¥í•´ë‘” ë…¸ë“œ ë§µì—ì„œ ì¢Œí‘œ ì°¾ê¸°
                if (loc) {
                    linePath.push(new kakao.maps.LatLng(loc.lat, loc.lng));
                }
            });

            // ì§€ë„ì— ì„  ê¸‹ê¸°
            currentPolyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 6, // ì„  ë‘ê»˜
                strokeColor: '#FF0000', // ì„  ìƒ‰ê¹” (ë¹¨ê°•)
                strokeOpacity: 0.8, // ì„  íˆ¬ëª…ë„
                strokeStyle: 'solid' // ì„  ìŠ¤íƒ€ì¼
            });
            currentPolyline.setMap(map);

            // ê²½ë¡œê°€ ë‹¤ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
            var bounds = new kakao.maps.LatLngBounds();
            linePath.forEach(coord => bounds.extend(coord));
            map.setBounds(bounds);
        }
    </script>
</body>

</html>