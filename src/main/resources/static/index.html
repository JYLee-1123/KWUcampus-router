<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê´‘ìš´ëŒ€ ìº í¼ìŠ¤ ê¸¸ì°¾ê¸°</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Noto Sans KR', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        h3 {
            margin: 0;
            color: #800020;
        }

        select,
        button,
        textarea {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background-color: #800020;
            color: white;
            border: none;
            font-weight: bold;
        }

        hr {
            width: 100%;
            border: 0.5px solid #eee;
            margin: 0;
        }

        .options {
            display: flex;
            gap: 15px;
            font-size: 14px;
            align-items: center;
        }

        .result-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
            color: #333;
            min-height: 20px;
        }

        /* [ìš´ì˜ì íŒ¨ë„] (í‰ì†Œì—” ìˆ¨ê¹€) */
        #admin-panel {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            font-size: 13px;
        }

        .admin-title {
            font-weight: bold;
            color: #856404;
            display: block;
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .feedback-list {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            margin-top: 5px;
        }

        .feedback-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .feedback-cat {
            color: #d9534f;
            font-weight: bold;
            margin-right: 5px;
        }

        /* ì‹ ê³  ëª¨ë‹¬ì°½ */
        #report-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            width: 300px;
        }

        /* ìš´ì˜ì ì§„ì… ë²„íŠ¼ */
        .admin-trigger {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 20;
            opacity: 0.3;
            cursor: pointer;
            font-size: 20px;
        }

        .admin-trigger:hover {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="control-panel">
        <h3>ğŸš€ ê´‘ìš´ëŒ€ ë„¤ë¹„ê²Œì´ì…˜</h3>
        <button id="btn-gps" style="background-color: #f0f0f0; color: #333;">ğŸ“ ë‚´ ìœ„ì¹˜ ì°¾ê¸°</button>
        <div id="gps-status" style="font-size: 12px; color: gray;">ìœ„ì¹˜ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.</div>
        <hr>
        <label>ëª©ì ì§€ ì„ íƒ:</label>
        <select id="destination-select">
            <option value="">ë¡œë”© ì¤‘...</option>
        </select>
        <div class="options">
            <label><input type="checkbox" id="avoidStair"> ê³„ë‹¨ íšŒí”¼ ğŸªœ</label>
            <label><input type="checkbox" id="avoidCrub"> í„± íšŒí”¼ ğŸ¦½</label>
        </div>
        <button id="btn-find">ê¸¸ì°¾ê¸° ì‹œì‘</button>
        <div id="result-msg" class="result-box">ê²½ë¡œ ëŒ€ê¸° ì¤‘...</div>
        <hr>

        <button id="btn-report" style="background-color: #555;">ğŸ“¢ ë¶ˆí¸ ì‹ ê³ í•˜ê¸°</button>

        <div id="admin-panel">
            <span class="admin-title">ğŸ‘® ìš´ì˜ì ëª¨ë“œ (DBì—°ë™ë¨)</span>
            <div>
                <label><input type="checkbox" id="chk-show-nodes"> ë…¸ë“œ ë³´ê¸°</label><br>
                <label><input type="checkbox" id="chk-show-edges"> ì—£ì§€ ë³´ê¸°</label>
            </div>
            <div style="font-weight: bold; margin-top:5px;">ğŸ“© ë¯¼ì› ëª©ë¡</div>
            <div id="feedback-container" class="feedback-list">
                <div style="padding:5px; color:gray;">ë°ì´í„° ì—†ìŒ</div>
            </div>
            <button onclick="loadFeedback()"
                style="width:100%; margin-top:5px; font-size:11px; padding:5px;">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <div class="admin-trigger" onclick="enterAdminMode()">ğŸ”</div>

    <div id="report-modal">
        <h3 style="margin-top:0;">ğŸš¨ ë¶ˆí¸ ì‚¬í•­ ì‹ ê³ </h3>
        <select id="report-category" style="width: 100%; margin-bottom: 10px;">
            <option value="ê³ ì¥">ì‹œì„¤ë¬¼ ê³ ì¥</option>
            <option value="ì¥ì• ë¬¼">í†µí–‰ ë°©í•´ë¬¼</option>
            <option value="ì˜¤ë¥˜">ì§€ë„ ì˜¤ë¥˜</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        <textarea id="report-content" rows="4" style="width: 100%; margin-bottom: 10px;"
            placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="document.getElementById('report-modal').style.display='none'"
                style="background-color:#ccc; color:black;">ì·¨ì†Œ</button>
            <button onclick="submitReport()" style="background-color:#d9534f;">ì œì¶œ</button>
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=311249e270cbeaab55beccff189121ab"></script>

    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = { center: new kakao.maps.LatLng(37.619501, 127.059594), level: 3 };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        var userLat = null, userLng = null, userMarker = null, currentPolyline = null;
        var nodeDataMap = {}, debugNodeMarkers = [], debugEdgePolylines = [];

        window.onload = function () {
            fetch('/api/buildings').then(r => r.json()).then(d => {
                const sel = document.getElementById('destination-select');
                sel.innerHTML = '<option value="">ë¹Œë”©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                d.forEach(b => { let o = document.createElement('option'); o.value = b.id; o.text = b.name; sel.appendChild(o); });
            });
            fetch('/api/nodes').then(r => r.json()).then(d => { d.forEach(n => nodeDataMap[n.id] = n.location); });
        };

        // [ìš´ì˜ì ëª¨ë“œ]
        function enterAdminMode() {
            if (prompt("ë¹„ë°€ë²ˆí˜¸:") === "1234") {
                document.getElementById('admin-panel').style.display = 'block';
                loadFeedback();
            } else { alert("ì˜¤ë¥˜"); }
        }

        // [ì‹ ê³  ì œì¶œ]
        document.getElementById('btn-report').addEventListener('click', () => document.getElementById('report-modal').style.display = 'block');
        function submitReport() {
            const cat = document.getElementById('report-category').value;
            const content = document.getElementById('report-content').value;
            if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category: cat, content: content, lat: userLat || 0, lng: userLng || 0 })
            }).then(res => {
                if (res.ok) { alert("ì ‘ìˆ˜ ì™„ë£Œ!"); document.getElementById('report-modal').style.display = 'none'; document.getElementById('report-content').value = ''; }
            });
        }

        // [ì‹ ê³  ì¡°íšŒ]
        function loadFeedback() {
            fetch('/api/feedback').then(r => r.json()).then(list => {
                const box = document.getElementById('feedback-container');
                box.innerHTML = "";
                if (list.length === 0) box.innerHTML = "<div style='padding:5px; color:gray;'>ì—†ìŒ</div>";
                list.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'feedback-item';
                    div.innerHTML = `<span class='feedback-cat'>[${item.category}]</span> ${item.content}`;
                    box.appendChild(div);
                });
            });
        }

        // [ë””ë²„ê·¸ ê¸°ëŠ¥]
        document.getElementById('chk-show-nodes').addEventListener('change', function (e) {
            if (e.target.checked) { for (const [id, loc] of Object.entries(nodeDataMap)) { var m = new kakao.maps.Marker({ position: new kakao.maps.LatLng(loc.lat, loc.lng), title: id }); m.setMap(map); debugNodeMarkers.push(m); } }
            else { debugNodeMarkers.forEach(m => m.setMap(null)); debugNodeMarkers = []; }
        });
        document.getElementById('chk-show-edges').addEventListener('change', function (e) {
            if (e.target.checked) { fetch('/api/edges').then(r => r.json()).then(edges => { edges.forEach(edge => { const f = nodeDataMap[edge.from], t = nodeDataMap[edge.to]; if (f && t) { var l = new kakao.maps.Polyline({ path: [new kakao.maps.LatLng(f.lat, f.lng), new kakao.maps.LatLng(t.lat, t.lng)], strokeColor: '#AAA' }); l.setMap(map); debugEdgePolylines.push(l); } }); }); }
            else { debugEdgePolylines.forEach(l => l.setMap(null)); debugEdgePolylines = []; }
        });

        // [ê¸°ë³¸ ê¸°ëŠ¥]
        document.getElementById('btn-gps').addEventListener('click', function () {
            if (navigator.geolocation) navigator.geolocation.getCurrentPosition(p => {
                userLat = p.coords.latitude; userLng = p.coords.longitude;
                document.getElementById('gps-status').innerText = "ìœ„ì¹˜ í™•ì¸ë¨ âœ…";
                if (userMarker) userMarker.setMap(null);
                userMarker = new kakao.maps.Marker({ map: map, position: new kakao.maps.LatLng(userLat, userLng) });
                map.setCenter(new kakao.maps.LatLng(userLat, userLng));
            });
        });
        kakao.maps.event.addListener(map, 'click', function (e) {
            userLat = e.latLng.getLat(); userLng = e.latLng.getLng();
            document.getElementById('gps-status').innerText = "ì§€ë„ ì„ íƒë¨ ğŸ‘†";
            if (userMarker) userMarker.setMap(null);
            userMarker = new kakao.maps.Marker({ map: map, position: e.latLng });
        });
        document.getElementById('btn-find').addEventListener('click', function () {
            if (!userLat) return alert("ì¶œë°œì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”");
            const bId = document.getElementById('destination-select').value;
            if (!bId) return alert("ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”");
            const stair = document.getElementById('avoidStair').checked;
            const crub = document.getElementById('avoidCrub').checked;

            fetch(`/api/find?lat=${userLat}&lng=${userLng}&building=${bId}&avoidStair=${stair}&avoidCrub=${crub}`)
                .then(r => { if (!r.ok) throw new Error(); return r.json(); })
                .then(res => {
                    let msg = "";
                    if (res.hasStair) msg += "âš ï¸ ê³„ë‹¨ í¬í•¨ ";
                    if (res.hasCrub) msg += "âš ï¸ í„± í¬í•¨ ";

                    if (!res.hasStair && !res.hasCrub) {
                        msg += "âœ… íœ ì²´ì–´ ì´ë™ ê°€ëŠ¥ ";
                    }
                    msg += `(${Math.round(res.cost)}m)`;

                    const resultBox = document.getElementById('result-msg');
                    resultBox.innerText = msg;

                    if (res.hasStair || res.hasCrub) {
                        resultBox.style.color = "#d9534f";
                        resultBox.style.fontWeight = "bold";
                    } else {
                        resultBox.style.color = "#006400";
                        resultBox.style.fontWeight = "normal";
                    }
                    if (currentPolyline) currentPolyline.setMap(null);
                    var path = [new kakao.maps.LatLng(userLat, userLng)];
                    res.path.forEach(id => { if (nodeDataMap[id]) path.push(new kakao.maps.LatLng(nodeDataMap[id].lat, nodeDataMap[id].lng)); });
                    currentPolyline = new kakao.maps.Polyline({ path: path, strokeWeight: 6, strokeColor: 'red' });
                    currentPolyline.setMap(map);
                }).catch(() => alert("ê²½ë¡œ ì—†ìŒ"));
        });
    </script>
</body>

</html>